@model IEnumerable<CineplexCustomerWebsite.Models.Seating>

@{
    ViewBag.Title = "Graphical Seat Booking";
}


@section scripts {
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the page.-->
    <script>
        var chosenSeats = [];
        var hub;
        var submitted = false;

        $(document).ready(function() {
            hub = $.connection.seatAvailabilityHub;
            $.connection.hub.start();
            hub.client.setSeatAvailability = function(seatId, available) {
                if (available) {
                    $("#"+seatId).attr("src", "/Content/Icons/seatAvailable.png");
                    $("#"+seatId).prop('disabled', false);
                } else {
                    $("#"+seatId).attr("src", "/Content/Icons/seatTaken.png");
                    $("#"+seatId).prop('disabled', true);
                }
            }
            hub.client.queryChosenSeats = function() {
                $.each(chosenSeats, function( index, value ) {
                    hub.server.signalAvailability(value, false);
                });
            }
        });

        $(window).bind("beforeunload", function() {
            if (!submitted) {
                $.each(chosenSeats, function( index, value ) {
                    hub.server.signalAvailability(value, true);
                });
            }        
        });

        $(document).submit(function(){
            submitted = true;
        });
    </script>
}
<h2>Booking</h2>

<div class="jumbotron">
    <table style="margin-left: auto; margin-right: auto">

        <img src="~/Content/Icons/Screen.png" width="400" height="10" style="display: block; margin-left: auto; margin-right: auto" />
        <br />
        @for (int i = 0; i < ViewBag.maxSeatsPerRow + 2; i++)
        {
            <col width="50">
        }

        @foreach (var row in ViewBag.Rows)
        {
            <tr>
                @{ var seatsInRow = Model.Where(seat => seat.SessionID == ViewBag.MovieSessionID && seat.Row == row);}
                @{ int columnsToSkip = (ViewBag.maxSeatsPerRow - seatsInRow.Count()) / 2;}
                @for (int i = 0; i < columnsToSkip; i++)
                {
                    <td></td>
                }
                @foreach (var seat in seatsInRow)
                {
                    <td>
                        @if (seat.IsTaken)
                        {
                            <input id="@seat.SeatingID" type="image" src="~/Content/Icons/seatTaken.png" disabled>
                        }
                        else
                        {
                            <input id="@seat.SeatingID" type="image" src="/Content/Icons/seatAvailable.png" />
                            <script>
                                $(document).ready(function () {
                                    $("#@seat.SeatingID").click(function () {
                                        var index = $.inArray(@seat.SeatingID, chosenSeats);
                                        if (index!=-1) {
                                            chosenSeats.splice(index, 1);
                                            $(this).attr("src", "/Content/Icons/seatAvailable.png");
                                            hub.server.signalAvailability(@seat.SeatingID, true);
                                        } else {
                                            chosenSeats.push(@seat.SeatingID);
                                            $(this).attr("src", "/Content/Icons/seatChosen.png");
                                            hub.server.signalAvailability(@seat.SeatingID, false);
                                        }
                                        $("#submitChosenSeats").val(chosenSeats);
                                    });
                                });
                            </script>
                        }
                    </td>
                }
            </tr>
        }
    </table>
</div>
<br />

<div class="row">
    <div class="col-sm-2">
        @using (Html.BeginForm("ConfirmBooking", "Booking", FormMethod.Post))
        {
            <input type="hidden" name="submitChosenSeats" id="submitChosenSeats" />
            <input type="submit" class="btn btn-success" value="Confirm" />
        }
    </div>
    <div class="col-sm-2">
        @using (Html.BeginForm("CancelBookingProcess", "Seating"))
        {
            <input type="submit" class="btn btn-danger" value="Cancel" />
        }
    </div>
    <div class="col-sm-8"></div>
</div>
